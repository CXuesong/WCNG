{"version":3,"sources":["src/script/wcng/localization.ts"],"names":[],"mappings":"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","file":"localization.js","sourcesContent":["/// <reference path=\"../../../typings/index.d.ts\"/>\r\n\r\nimport * as Schemas from \"./schemas\"\r\n\r\ntype TextDict = { [key: string]: string };\r\n\r\nfunction fallbackLanguageTag(tag: string) {\r\n    let index = tag.lastIndexOf(\"-\");\r\n    if (index <= 0) return \"\";\r\n    return tag.substr(0, index);\r\n}\r\n\r\nexport class LocalizedResourceProvider {\r\n\r\n    public static readonly LocalizedResourcePath = \"data/localization\";\r\n    public static readonly FallbackLanguage = \"en\";\r\n\r\n    private loadedDicts: { [locale: string]: TextDict } = {};\r\n    private observables: { [key: string]: KnockoutObservable<string> } = {};\r\n    private _currentLocale: string;\r\n    private _catalog: Schemas.LocalizationCatalog;\r\n\r\n    constructor(locale: string) {\r\n        $.getJSON(LocalizedResourceProvider.LocalizedResourcePath + \"/catalog.json\",\r\n            (data: Schemas.LocalizationCatalog, textStatus, jqXHR) => {\r\n                this._catalog = data;\r\n                this.setCurrentLocale(locale);\r\n            });\r\n    }\r\n\r\n    public getCurrentLocale() {\r\n        return this._currentLocale;\r\n    }\r\n\r\n    public setCurrentLocale(value: string) {\r\n        console.assert(!!this._catalog);\r\n        value = (value || \"\").toLowerCase();\r\n        while (value && this._catalog.languages.indexOf(value) < 0) {\r\n            value = fallbackLanguageTag(value);\r\n        }\r\n        if (!value) {\r\n            console.assert(this._catalog.languages.indexOf(LocalizedResourceProvider.FallbackLanguage) >= 0);\r\n            value = LocalizedResourceProvider.FallbackLanguage;\r\n        }\r\n        this._currentLocale = value;\r\n        if (!(value in this.loadedDicts)) {\r\n            this.loadedDicts[value] = null;\r\n            this.fetchResourceDictAsync(value, (dict => {\r\n                console.debug(\"Loaded resource dictionary for \", value);\r\n                this.loadedDicts[value] = dict;\r\n                if (this._currentLocale == value)\r\n                    this.refreshObservables();\r\n            }));\r\n        }\r\n    }\r\n\r\n    public getString(key: string) {\r\n        var dict = this.loadedDicts[this._currentLocale];\r\n        return dict ? dict[key] : null;\r\n    }\r\n\r\n    public getObservableString(key: string) {\r\n        let v = this.observables[key];\r\n        if (v) return v;\r\n        let lv = this.getString(key);\r\n        v = ko.observable(lv || `[${key}]`);\r\n        this.observables[key] = v;\r\n        return v;\r\n    }\r\n\r\n    public refreshObservables() {\r\n        for (let key in this.observables) {\r\n            let lv = this.getString(key);\r\n            // console.debug(key, lv);\r\n            if (lv) this.observables[key](lv);\r\n        }\r\n    }\r\n\r\n    private fetchResourceDictAsync(locale: string, callback: (dict: TextDict) => any) {\r\n        console.assert(!!locale);\r\n        $.getJSON(`${LocalizedResourceProvider.LocalizedResourcePath}/${locale}/text.json`,\r\n            (data: TextDict, textStatus, jqXHR) => callback(data));\r\n    }\r\n}\r\n\r\n"]}